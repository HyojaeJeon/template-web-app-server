/**
 * Local App ì ì£¼ ëŒ€ì‹œë³´ë“œ ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´
 * OWASP Top 10 ë° Local ë¡œì»¬ ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ ì¤€ìˆ˜
 * 
 * ì£¼ìš” ë³´ì•ˆ ê¸°ëŠ¥:
 * - JWT í† í° ê²€ì¦ ë° ê°±ì‹ 
 * - Rate Limiting (Local ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ê³ ë ¤)
 * - CSP (Content Security Policy) ê°•í™”
 * - XSS, CSRF ë³´í˜¸
 * - Local ê°œì¸ì •ë³´ë³´í˜¸ë²• ì¤€ìˆ˜
 */

'use client'

import { NextResponse } from 'next/server'
import jwt from 'jsonwebtoken'

/**
 * ë³´ì•ˆ í—¤ë” ì„¤ì •
 */
const SECURITY_HEADERS = {
  // XSS ë³´í˜¸ ê°•í™”
  'X-XSS-Protection': '1; mode=block',
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-DNS-Prefetch-Control': 'off',
  
  // Local í˜„ì§€ ì»´í”Œë¼ì´ì–¸ìŠ¤
  'X-Vietnam-Privacy-Compliance': 'PDPA-2023',
  'X-Data-Classification': 'Internal',
  
  // HSTS (HTTPS ê°•ì œ)
  'Strict-Transport-Security': 'max-age=63072000; includeSubDomains; preload',
  
  // ì¶”ì²œ ë³´ì•ˆ í—¤ë”
  'Referrer-Policy': 'origin-when-cross-origin',
  'Permissions-Policy': 'camera=(), microphone=(), geolocation=self, payment=self',
  
  // CSP (Content Security Policy) - Local App íŠ¹í™”
  'Content-Security-Policy': [
    "default-src 'self'",
    "script-src 'self' 'unsafe-eval' 'unsafe-inline' https://www.google-analytics.com https://connect.facebook.net",
    "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
    "font-src 'self' https://fonts.gstatic.com",
    "img-src 'self' data: https: blob:",
    "media-src 'self' https:",
    "connect-src 'self' https://api.template.com wss://api.template.com https://graph.facebook.com https://www.google-analytics.com",
    "object-src 'none'",
    "base-uri 'self'",
    "form-action 'self'",
    "frame-ancestors 'none'",
    "upgrade-insecure-requests"
  ].join('; ')
}

/**
 * Rate Limiting ì„¤ì • (Local ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ê³ ë ¤)
 */
class VietnamRateLimiter {
  constructor() {
    this.requests = new Map()
    this.suspiciousIPs = new Set()
    
    // Local ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ ì´ˆê¸°í™”
    this.vietnamTime = new Intl.DateTimeFormat('vi-VN', {
      timeZone: 'Asia/Ho_Chi_Minh'
    })
  }
  
  /**
   * Rate limit ì²´í¬ (Local ì‚¬ìš©ì íŒ¨í„´ ê³ ë ¤)
   * @param {string} clientIP - í´ë¼ì´ì–¸íŠ¸ IP
   * @param {string} endpoint - API ì—”ë“œí¬ì¸íŠ¸
   * @returns {Object} rate limit ê²°ê³¼
   */
  checkRateLimit(clientIP, endpoint) {
    const now = Date.now();
    const key = `${clientIP}:${endpoint}`;
    
    if (!this.requests.has(key)) {
      this.requests.set(key, []);
    }\n    \n    const requests = this.requests.get(key)\n    \n    // 1ë¶„ ì´ì „ ìš”ì²­ ì œê±°\n    const oneMinuteAgo = now - 60000\n    const recentRequests = requests.filter(time => time > oneMinuteAgo)\n    this.requests.set(key, recentRequests)\n    \n    // ì—”ë“œí¬ì¸íŠ¸ë³„ ì œí•œ ì„¤ì • (Local ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ê³ ë ¤)\n    const limits = {\n      '/api/auth/login': 5, // ë¡œê·¸ì¸ ì‹œë„\n      '/api/orders': 60,    // ì£¼ë¬¸ ì¡°íšŒ\n      '/api/menu': 100,     // ë©”ë‰´ ì¡°íšŒ\n      '/api/analytics': 30, // ë¶„ì„ ë°ì´í„°\n      '/api/chat': 120,     // ì±„íŒ… ë©”ì‹œì§€\n      'default': 100        // ê¸°ë³¸ ì œí•œ\n    }\n    \n    const limit = limits[endpoint] || limits.default\n    \n    // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ IP ë” ì—„ê²©í•œ ì œí•œ\n    const finalLimit = this.suspiciousIPs.has(clientIP) ? Math.floor(limit / 2) : limit\n    \n    if (recentRequests.length >= finalLimit) {\n      // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ ê¸°ë¡\n      if (recentRequests.length > limit * 1.5) {\n        this.suspiciousIPs.add(clientIP)\n        console.warn(`ğŸš¨ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ ê°ì§€: ${clientIP} - ${endpoint}`);\n      }\n      \n      return {\n        allowed: false,\n        remaining: 0,\n        resetTime: oneMinuteAgo + 60000,\n        message: 'ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'\n      }\n    }\n    \n    // ìš”ì²­ ê¸°ë¡\n    recentRequests.push(now)\n    \n    return {\n      allowed: true,\n      remaining: finalLimit - recentRequests.length,\n      resetTime: oneMinuteAgo + 60000\n    }\n  }\n  \n  /**\n   * ì˜ì‹¬ìŠ¤ëŸ¬ìš´ IP í•´ì œ (24ì‹œê°„ í›„ ìë™)\n   */\n  cleanupSuspiciousIPs() {\n    // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Redisë‚˜ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥\n    console.log('ğŸ§¹ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ IP ëª©ë¡ ì •ë¦¬ ì™„ë£Œ')\n  }\n}\n\nconst rateLimiter = new VietnamRateLimiter()\n\n/**\n * JWT í† í° ê²€ì¦ ìœ í‹¸ë¦¬í‹°\n */\nclass TokenValidator {\n  static JWT_SECRET = process.env.JWT_SECRET || 'vietnam-delivery-secret'\n  static REFRESH_SECRET = process.env.JWT_REFRESH_SECRET || 'vietnam-delivery-refresh'\n  \n  /**\n   * ì•¡ì„¸ìŠ¤ í† í° ê²€ì¦\n   * @param {string} token - JWT í† í°\n   * @returns {Object} í† í° ê²€ì¦ ê²°ê³¼\n   */\n  static validateAccessToken(token) {\n    try {\n      const decoded = jwt.verify(token, this.JWT_SECRET)\n      \n      // í† í° ë§Œë£Œ ì‹œê°„ í™•ì¸ (5ë¶„ ì „ ê°±ì‹  ê¶Œì¥)\n      const now = Math.floor(Date.now() / 1000)\n      const timeUntilExpiry = decoded.exp - now\n      \n      return {\n        valid: true,\n        decoded,\n        needsRefresh: timeUntilExpiry <= 300, // 5ë¶„\n        expiresIn: timeUntilExpiry\n      }\n    } catch (error) {\n      return {\n        valid: false,\n        error: error.message,\n        needsRefresh: true\n      }\n    }\n  }\n  \n  /**\n   * ë¦¬í”„ë ˆì‹œ í† í° ê²€ì¦\n   * @param {string} refreshToken - ë¦¬í”„ë ˆì‹œ í† í°\n   * @returns {Object} í† í° ê²€ì¦ ê²°ê³¼\n   */\n  static validateRefreshToken(refreshToken) {\n    try {\n      const decoded = jwt.verify(refreshToken, this.REFRESH_SECRET)\n      return {\n        valid: true,\n        decoded\n      }\n    } catch (error) {\n      return {\n        valid: false,\n        error: error.message\n      }\n    }\n  }\n}\n\n/**\n * ì…ë ¥ ë°ì´í„° ìƒˆë‹ˆíƒ€ì´ì œì´ì…˜ (Localì–´ íŠ¹ìˆ˜ë¬¸ì ê³ ë ¤)\n */\nclass DataSanitizer {\n  /**\n   * SQL ì¸ì ì…˜ ë°©ì§€\n   * @param {string} input - ì‚¬ìš©ì ì…ë ¥\n   * @returns {string} ìƒˆë‹ˆíƒ€ì´ì¦ˆëœ ì…ë ¥\n   */\n  static sanitizeSQL(input) {\n    if (typeof input !== 'string') return input\n    \n    // ìœ„í—˜í•œ SQL í‚¤ì›Œë“œ í•„í„°ë§\n    const sqlPatterns = [\n      /('|(\\-\\-)|(;)|(\\||\\|)|(\\*)|(%))/i,\n      /(exec|execute|select|insert|update|delete|drop|create|alter|union|script)/i\n    ]\n    \n    let sanitized = input\n    sqlPatterns.forEach(pattern => {\n      sanitized = sanitized.replace(pattern, '')\n    })\n    \n    return sanitized.trim()\n  }\n  \n  /**\n   * XSS ë°©ì§€ (Localì–´ íŠ¹ìˆ˜ë¬¸ì ë³´ì¡´)\n   * @param {string} input - ì‚¬ìš©ì ì…ë ¥\n   * @returns {string} ìƒˆë‹ˆíƒ€ì´ì¦ˆëœ ì…ë ¥\n   */\n  static sanitizeXSS(input) {\n    if (typeof input !== 'string') return input\n    \n    // HTML íƒœê·¸ ì œê±° (Localì–´ í…ìŠ¤íŠ¸ëŠ” ë³´ì¡´)\n    return input\n      .replace(/<script[^>]*>.*?<\\/script>/gi, '')\n      .replace(/<iframe[^>]*>.*?<\\/iframe>/gi, '')\n      .replace(/<object[^>]*>.*?<\\/object>/gi, '')\n      .replace(/<embed[^>]*>.*?<\\/embed>/gi, '')\n      .replace(/on\\w+=[\"'][^\"']*[\"']/gi, '')\n      .replace(/javascript:/gi, '')\n      .replace(/vbscript:/gi, '')\n      .trim()\n  }\n  \n  /**\n   * Local ì „í™”ë²ˆí˜¸ ê²€ì¦ ë° ìƒˆë‹ˆíƒ€ì´ì œì´ì…˜\n   * @param {string} phone - ì „í™”ë²ˆí˜¸\n   * @returns {string} ì •ê·œí™”ëœ ì „í™”ë²ˆí˜¸\n   */\n  static sanitizeVietnamesePhone(phone) {\n    if (!phone) return ''\n    \n    // Local ì „í™”ë²ˆí˜¸ íŒ¨í„´: +84, 84, 0ìœ¼ë¡œ ì‹œì‘\n    const cleanPhone = phone.replace(/[^\\d+]/g, '')\n    \n    // Local ëª¨ë°”ì¼ ë²ˆí˜¸ í˜•ì‹ ì •ê·œí™”\n    if (cleanPhone.startsWith('0')) {\n      return `+84${cleanPhone.substring(1)}`\n    } else if (cleanPhone.startsWith('84')) {\n      return `+${cleanPhone}`\n    } else if (cleanPhone.startsWith('+84')) {\n      return cleanPhone\n    }\n    \n    return cleanPhone\n  }\n}\n\n/**\n * Local ê°œì¸ì •ë³´ë³´í˜¸ë²• ì¤€ìˆ˜ ì²´í¬\n */\nclass VietnamPrivacyCompliance {\n  /**\n   * ê°œì¸ì •ë³´ ì²˜ë¦¬ ë™ì˜ ê²€ì¦\n   * @param {Object} userData - ì‚¬ìš©ì ë°ì´í„°\n   * @returns {Object} ì»´í”Œë¼ì´ì–¸ìŠ¤ ì²´í¬ ê²°ê³¼\n   */\n  static checkDataProcessingConsent(userData) {\n    const requiredConsents = [\n      'dataProcessing', // ê°œì¸ì •ë³´ ì²˜ë¦¬ ë™ì˜\n      'marketing',      // ë§ˆì¼€íŒ… í™œìš© ë™ì˜\n      'thirdParty'      // ì œ3ì ì œê³µ ë™ì˜\n    ]\n    \n    const missingConsents = requiredConsents.filter(\n      consent => !userData.consents?.[consent]\n    )\n    \n    return {\n      compliant: missingConsents.length === 0,\n      missingConsents,\n      message: missingConsents.length > 0 ? \n        `Local ê°œì¸ì •ë³´ë³´í˜¸ë²•ì— ë”°ë¥¸ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤: ${missingConsents.join(', ')}` :\n        'ê°œì¸ì •ë³´ ì²˜ë¦¬ ë™ì˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'\n    }\n  }\n  \n  /**\n   * ë¯¼ê°í•œ ë°ì´í„° ë§ˆìŠ¤í‚¹\n   * @param {Object} data - ë§ˆìŠ¤í‚¹í•  ë°ì´í„°\n   * @returns {Object} ë§ˆìŠ¤í‚¹ëœ ë°ì´í„°\n   */\n  static maskSensitiveData(data) {\n    const sensitiveFields = ['phone', 'email', 'address', 'bankAccount', 'idNumber']\n    const masked = { ...data }\n    \n    sensitiveFields.forEach(field => {\n      if (masked[field]) {\n        const value = masked[field].toString()\n        if (field === 'phone') {\n          // Local ì „í™”ë²ˆí˜¸ ë§ˆìŠ¤í‚¹: +84*****1234\n          masked[field] = value.replace(/(\\+84)(\\d{1,2})(\\d+)(\\d{4})/, '$1*****$4')\n        } else if (field === 'email') {\n          // ì´ë©”ì¼ ë§ˆìŠ¤í‚¹: user***@example.com\n          masked[field] = value.replace(/(\\w{1,3})\\w+(@.+)/, '$1***$2')\n        } else if (field === 'address') {\n          // ì£¼ì†Œ ë§ˆìŠ¤í‚¹ (Local ì£¼ì†Œ ì²´ê³„)\n          masked[field] = value.replace(/(\\w+\\s+).+(\\s+\\w+\\s*$)/, '$1***$2')\n        }\n      }\n    })\n    \n    return masked\n  }\n}\n\n/**\n * ë©”ì¸ ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜\n */\nexport async function securityMiddleware(request) {\n  const { nextUrl, headers, method, ip } = request\n  const response = NextResponse.next()\n  \n  // ë³´ì•ˆ í—¤ë” ì„¤ì •\n  Object.entries(SECURITY_HEADERS).forEach(([key, value]) => {\n    response.headers.set(key, value)\n  })\n  \n  // Local ì‹œê°„ëŒ€ í—¤ë” ì¶”ê°€\n  response.headers.set('X-Server-Timezone', 'Asia/Ho_Chi_Minh')\n  response.headers.set('X-Server-Time', new Date().toISOString())\n  \n  // Rate Limiting ì²´í¬\n  const rateLimit = rateLimiter.checkRateLimit(\n    ip || headers.get('x-forwarded-for') || 'unknown',\n    nextUrl.pathname\n  )\n  \n  if (!rateLimit.allowed) {\n    return new NextResponse(\n      JSON.stringify({\n        error: 'TOO_MANY_REQUESTS',\n        message: rateLimit.message,\n        retryAfter: Math.ceil((rateLimit.resetTime - Date.now()) / 1000),\n        vietnamese: {\n          message: 'QuÃ¡ nhiá»u yÃªu cáº§u. Vui lÃ²ng thá»­ láº¡i sau.',\n          timezone: 'Asia/Ho_Chi_Minh'\n        }\n      }),\n      {\n        status: 429,\n        headers: {\n          'Content-Type': 'application/json',\n          'Retry-After': Math.ceil((rateLimit.resetTime - Date.now()) / 1000).toString(),\n          'X-RateLimit-Remaining': '0',\n          'X-RateLimit-Reset': rateLimit.resetTime.toString()\n        }\n      }\n    )\n  }\n  \n  // Rate limit ì •ë³´ í—¤ë” ì¶”ê°€\n  response.headers.set('X-RateLimit-Remaining', rateLimit.remaining.toString())\n  response.headers.set('X-RateLimit-Reset', rateLimit.resetTime.toString())\n  \n  // API ê²½ë¡œì— ëŒ€í•œ ì¸ì¦ ì²´í¬\n  if (nextUrl.pathname.startsWith('/api/protected') || \n      nextUrl.pathname.startsWith('/dashboard')) {\n    \n    const authHeader = headers.get('authorization')\n    const cookieToken = request.cookies.get('auth-token')?.value\n    \n    const token = authHeader?.replace('Bearer ', '') || cookieToken\n    \n    if (!token) {\n      return new NextResponse(\n        JSON.stringify({\n          error: 'UNAUTHORIZED',\n          message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤',\n          vietnamese: {\n            message: 'Cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ truy cáº­p',\n            redirectUrl: '/login'\n          }\n        }),\n        {\n          status: 401,\n          headers: {\n            'Content-Type': 'application/json',\n            'WWW-Authenticate': 'Bearer realm=\"Vietnam Delivery Store\"'\n          }\n        }\n      )\n    }\n    \n    // JWT í† í° ê²€ì¦\n    const tokenValidation = TokenValidator.validateAccessToken(token)\n    \n    if (!tokenValidation.valid) {\n      return new NextResponse(\n        JSON.stringify({\n          error: 'INVALID_TOKEN',\n          message: 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤',\n          needsRefresh: tokenValidation.needsRefresh,\n          vietnamese: {\n            message: 'Token khÃ´ng há»£p lá»‡. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.'\n          }\n        }),\n        {\n          status: 401,\n          headers: {\n            'Content-Type': 'application/json'\n          }\n        }\n      )\n    }\n    \n    // í† í° ê°±ì‹  í•„ìš” ì‹œ í—¤ë”ì— í‘œì‹œ\n    if (tokenValidation.needsRefresh) {\n      response.headers.set('X-Token-Refresh-Needed', 'true')\n      response.headers.set('X-Token-Expires-In', tokenValidation.expiresIn.toString())\n    }\n    \n    // ì‚¬ìš©ì ì •ë³´ë¥¼ requestì— ì¶”ê°€\n    response.headers.set('X-User-ID', tokenValidation.decoded.userId)\n    response.headers.set('X-User-Role', tokenValidation.decoded.role || 'user')\n  }\n  \n  // CSRF ë³´í˜¸ (ìƒíƒœ ë³€ê²½ ìš”ì²­ì— ëŒ€í•´)\n  if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {\n    const csrfToken = headers.get('x-csrf-token') || request.cookies.get('csrf-token')?.value\n    const origin = headers.get('origin')\n    const referer = headers.get('referer')\n    \n    // Origin/Referer ê²€ì¦\n    const allowedOrigins = [\n      'https://store.template.com',\n      'https://admin.template.com',\n      process.env.NODE_ENV === 'development' ? 'http://localhost:3000' : null\n    ].filter(Boolean)\n    \n    if (origin && !allowedOrigins.includes(origin)) {\n      console.warn(`ğŸš¨ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ Origin: ${origin} from IP: ${ip}`);\n      \n      return new NextResponse(\n        JSON.stringify({\n          error: 'INVALID_ORIGIN',\n          message: 'í—ˆìš©ë˜ì§€ ì•Šì€ ì¶œì²˜ì—ì„œì˜ ìš”ì²­ì…ë‹ˆë‹¤',\n          vietnamese: {\n            message: 'YÃªu cáº§u tá»« nguá»“n khÃ´ng Ä‘Æ°á»£c phÃ©p'\n          }\n        }),\n        {\n          status: 403,\n          headers: {\n            'Content-Type': 'application/json'\n          }\n        }\n      )\n    }\n  }\n  \n  // ë¡œê¹… (ë³´ì•ˆ ì´ë²¤íŠ¸)\n  if (process.env.NODE_ENV === 'production') {\n    console.log(`ğŸ” [ë³´ì•ˆ] ${method} ${nextUrl.pathname} - IP: ${ip} - ${new Date().toISOString()}`);\n  }\n  \n  return response\n}\n\n/**\n * API ê²½ë¡œë³„ ë³´ì•ˆ ê²€ì¦\n */\nexport const validateApiSecurity = {\n  /**\n   * ì£¼ë¬¸ API ë³´ì•ˆ ê²€ì¦\n   * @param {Object} orderData - ì£¼ë¬¸ ë°ì´í„°\n   * @returns {Object} ê²€ì¦ ê²°ê³¼\n   */\n  orders: (orderData) => {\n    const errors = []\n    \n    // ì£¼ë¬¸ ê¸ˆì•¡ ê²€ì¦ (ì´ìƒ ê±°ë˜ íƒì§€)\n    if (orderData.totalAmount > 10000000) { // 1ì²œë§Œ VND\n      errors.push('ë¹„ì •ìƒì ìœ¼ë¡œ ë†’ì€ ì£¼ë¬¸ ê¸ˆì•¡ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤')\n    }\n    \n    // Local ì£¼ì†Œ í˜•ì‹ ê²€ì¦\n    if (orderData.deliveryAddress && !orderData.deliveryAddress.includes('Vietnam')) {\n      console.warn('âš ï¸ Local ì™¸ ì§€ì—­ ë°°ë‹¬ ì£¼ì†Œ ê°ì§€:', orderData.deliveryAddress)\n    }\n    \n    return {\n      valid: errors.length === 0,\n      errors\n    }\n  },\n  \n  /**\n   * ê²°ì œ API ë³´ì•ˆ ê²€ì¦\n   * @param {Object} paymentData - ê²°ì œ ë°ì´í„°\n   * @returns {Object} ê²€ì¦ ê²°ê³¼\n   */\n  payments: (paymentData) => {\n    const errors = []\n    \n    // Local ê²°ì œ ìˆ˜ë‹¨ ê²€ì¦\n    const allowedMethods = ['momo', 'zalopay', 'vnpay', 'cod', 'card']\n    if (!allowedMethods.includes(paymentData.method)) {\n      errors.push('ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²°ì œ ìˆ˜ë‹¨ì…ë‹ˆë‹¤')\n    }\n    \n    // ê²°ì œ ê¸ˆì•¡ ê²€ì¦\n    if (paymentData.amount <= 0 || paymentData.amount > 50000000) { // 5ì²œë§Œ VND\n      errors.push('ìœ íš¨í•˜ì§€ ì•Šì€ ê²°ì œ ê¸ˆì•¡ì…ë‹ˆë‹¤')\n    }\n    \n    return {\n      valid: errors.length === 0,\n      errors\n    }\n  }\n}\n\n/**\n * ë³´ì•ˆ ì´ë²¤íŠ¸ ë¡œê¹…\n */\nexport class SecurityLogger {\n  static log(level, event, details = {}) {\n    const logData = {\n      timestamp: new Date().toISOString(),\n      timezone: 'Asia/Ho_Chi_Minh',\n      level,\n      event,\n      details,\n      vietnamese: {\n        timestamp: new Intl.DateTimeFormat('vi-VN', {\n          timeZone: 'Asia/Ho_Chi_Minh',\n          year: 'numeric',\n          month: '2-digit',\n          day: '2-digit',\n          hour: '2-digit',\n          minute: '2-digit',\n          second: '2-digit'\n        }).format(new Date())\n      }\n    }\n    \n    // í”„ë¡œë•ì…˜ì—ì„œëŠ” ì™¸ë¶€ ë¡œê¹… ì„œë¹„ìŠ¤ë¡œ ì „ì†¡\n    if (process.env.NODE_ENV === 'production') {\n      // TODO: Sentry, DataDog ë“±ìœ¼ë¡œ ì „ì†¡\n      console.log(`[SECURITY-${level}]`, logData)\n    } else {\n      console.log(`ğŸ” [${level}] ${event}:`, details)\n    }\n  }\n  \n  static error(event, details) {\n    this.log('ERROR', event, details)\n  }\n  \n  static warn(event, details) {\n    this.log('WARN', event, details)\n  }\n  \n  static info(event, details) {\n    this.log('INFO', event, details)\n  }\n}\n\nexport {\n  VietnamRateLimiter,\n  TokenValidator,\n  DataSanitizer,\n  VietnamPrivacyCompliance,\n  SecurityLogger\n}\n\nexport default securityMiddleware